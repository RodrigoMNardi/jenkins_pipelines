pipeline {
    agent {
        docker {
            image 'ruby:3.4'
        }
    }

    environment {
        POSTGRES_USER = 'postgres'
        POSTGRES_PASSWORD = 'postgres'
        POSTGRES_DB = 'postgres'
        POSTGRES_HOST = 'postgres'
    }

    services {
        postgres {
            image 'postgres:15'
            env {
                POSTGRES_USER = 'postgres'
                POSTGRES_PASSWORD = 'postgres'
                POSTGRES_DB = 'postgres'
            }
            options '--health-cmd="pg_isready -U postgres" --health-interval=10s --health-timeout=5s --health-retries=5'
        }
    }

    stages {
        stage('Checkout') {
            steps {
                deleteDir()
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: 'master']],
                    userRemoteConfigs: [[url: 'https://github.com/RodrigoMNardi/netdef-ci-github-app.git']]
                ])
            }
        }

        stage('Install bundler') {
            steps {
                sh 'gem install bundler -v 2.7.1'
            }
        }

        stage('Install gems') {
            steps {
                sh 'bundle install'
            }
        }

        stage('Create DB') {
            environment {
                RACK_ENV = 'test'
                DATABASE_URL = 'postgres://postgres:postgres@postgres'
            }
            steps {
                sh '''
                  cp database_template.yml config/database.yml
                  cp db/schema.rb db/schema.rb.bak
                  bundle exec rake db:migrate:reset
                  if ! cmp db/schema.rb db/schema.rb.bak >/dev/null 2>&1; then
                    echo 'Your db/schema.rb differs from the schema generated by the migrations.'
                    echo 'Use "DATABASE=migrations bundle exec rake db:migrate:reset" to regenerate the schema.'
                    diff db/schema.rb db/schema.rb.bak
                    exit 1
                  fi
                '''
            }
        }

        stage('Unit Tests') {
            steps {
                sh 'bundle exec rspec'
            }
        }
    }

    post {
        always {
            echo 'Pipeline done'
        }
        success {
            echo 'SUCCESS!'
        }
        failure {
            echo '‚ùå FAILURE!'
        }
    }
}
